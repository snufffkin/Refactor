# Инструкция по настройке базы данных на виртуальной машине

## Предварительные требования

- Виртуальная машина с Ubuntu (рекомендуется Ubuntu 20.04 LTS или новее)
- Права sudo
- Доступ к терминалу

## Шаги настройки

### 1. Экспорт данных с локального компьютера

Перед настройкой базы данных на виртуальной машине, необходимо экспортировать данные с локального компьютера:

```bash
# На локальном компьютере
./setup_db.sh export
```

Скрипт создаст файл `db_export.tar.gz` с экспортированными данными.

### 2. Загрузите скрипт и данные на виртуальную машину

Скопируйте файлы `setup_db.sh` и `db_export.tar.gz` на виртуальную машину:

```bash
scp setup_db.sh db_export.tar.gz user@your-ubuntu-vm-ip:~/
```

### 3. Сделайте скрипт исполняемым на виртуальной машине

```bash
chmod +x setup_db.sh
```

### 4. Установите базу данных и импортируйте данные

```bash
./setup_db.sh import
```

Скрипт выполнит следующие действия:
- Установит PostgreSQL, если он не установлен
- Создаст базу данных `course_quality`
- Создаст пользователя с вашим именем пользователя
- Создаст необходимые таблицы и представления
- Импортирует данные из архива `db_export.tar.gz`
- Настроит переменную окружения `DB_DSN`

### 5. Оптимизация базы данных (опционально)

После успешной настройки базы данных, запустите скрипт оптимизации для создания индексов и материализованных представлений:

```bash
cd /path/to/your/app
python optimize_db.py
```

## Структура базы данных

Основные таблицы:
- `cards_structure` - структура карточек (программы, модули, уроки, ГЗ)
- `cards_metrics` - метрики для карточек (попытки, успешность, жалобы)
- `card_status` - статусы карточек
- `users` - пользователи системы
- `card_assignments` - назначенные карточки
- `assignment_history` - история изменений

Представления:
- `cards_mv` - основное представление, объединяющее структуру, метрики и статусы

## Режимы работы скрипта

Скрипт `setup_db.sh` поддерживает три режима работы:

1. **Установка базы данных** (по умолчанию):
   ```bash
   ./setup_db.sh
   ```
   Создает пустую базу данных без данных.

2. **Экспорт данных** (на локальном компьютере):
   ```bash
   ./setup_db.sh export
   ```
   Экспортирует данные из локальной базы в архив `db_export.tar.gz`.

3. **Импорт данных** (на виртуальной машине):
   ```bash
   ./setup_db.sh import
   ```
   Устанавливает базу данных и импортирует данные из архива `db_export.tar.gz`.

## Возможные проблемы и их решение

### Ошибка при экспорте данных

Если при экспорте возникают ошибки, убедитесь, что:
- PostgreSQL запущен на локальном компьютере
- База данных `course_quality` существует и содержит данные
- У вас есть права на чтение из базы данных

### Ошибка при импорте данных

Убедитесь, что:
- Архив `db_export.tar.gz` находится в той же директории, что и скрипт
- У вас есть права на запись в директорию и базу данных

### Ошибка подключения к PostgreSQL

Если скрипт не может подключиться к PostgreSQL, убедитесь, что сервис запущен:

```bash
sudo systemctl status postgresql
```

Если сервис не запущен, запустите его:

```bash
sudo systemctl start postgresql
```

### Ошибка аутентификации

Если возникает ошибка аутентификации, проверьте настройки в файле `pg_hba.conf`:

```bash
sudo nano /etc/postgresql/версия_postgresql/main/pg_hba.conf
```

И убедитесь, что есть строка:

```
local   all             all                                     md5
```

После внесения изменений перезапустите PostgreSQL:

```bash
sudo systemctl restart postgresql
```

### Проблемы с переменной окружения

Если приложение не видит переменную окружения `DB_DSN`, перезапустите терминал или вручную экспортируйте её:

```bash
export DB_DSN="postgresql:///course_quality"
```

## Логин в приложение

После настройки базы данных вы сможете войти в приложение с учетными данными:

- **Администратор**:
  - Логин: admin
  - Пароль: admin123

- **Методист**:
  - Логин: methodist
  - Пароль: methodist123 