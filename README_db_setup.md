# Инструкция по настройке базы данных на виртуальной машине

## Предварительные требования

- Виртуальная машина с Ubuntu (рекомендуется Ubuntu 20.04 LTS или новее)
- Права sudo
- Доступ к терминалу

## Шаги настройки

### 1. Загрузите скрипт на виртуальную машину

Скопируйте файл `setup_db.sh` на виртуальную машину. Это можно сделать с помощью `scp` или копирования через SSH-клиент:

```bash
scp setup_db.sh user@your-ubuntu-vm-ip:~/
```

### 2. Сделайте скрипт исполняемым

```bash
chmod +x setup_db.sh
```

### 3. Запустите скрипт

```bash
./setup_db.sh
```

Скрипт выполнит следующие действия:
- Установит PostgreSQL, если он не установлен
- Создаст базу данных `course_quality`
- Создаст пользователя с вашим именем пользователя
- Создаст необходимые таблицы и представления
- Настроит переменную окружения `DB_DSN`

### 4. Оптимизация базы данных (опционально)

После успешного выполнения скрипта, запустите скрипт оптимизации для создания индексов и материализованных представлений:

```bash
cd /path/to/your/app
python optimize_db.py
```

## Структура базы данных

Основные таблицы:
- `cards_structure` - структура карточек (программы, модули, уроки, ГЗ)
- `cards_metrics` - метрики для карточек (попытки, успешность, жалобы)
- `card_status` - статусы карточек
- `users` - пользователи системы
- `card_assignments` - назначенные карточки
- `assignment_history` - история изменений

Представления:
- `cards_mv` - основное представление, объединяющее структуру, метрики и статусы

## Возможные проблемы и их решение

### Ошибка подключения к PostgreSQL

Если скрипт не может подключиться к PostgreSQL, убедитесь, что сервис запущен:

```bash
sudo systemctl status postgresql
```

Если сервис не запущен, запустите его:

```bash
sudo systemctl start postgresql
```

### Ошибка аутентификации

Если возникает ошибка аутентификации, проверьте настройки в файле `pg_hba.conf`:

```bash
sudo nano /etc/postgresql/версия_postgresql/main/pg_hba.conf
```

И убедитесь, что есть строка:

```
local   all             all                                     md5
```

После внесения изменений перезапустите PostgreSQL:

```bash
sudo systemctl restart postgresql
```

### Проблемы с переменной окружения

Если приложение не видит переменную окружения `DB_DSN`, перезапустите терминал или вручную экспортируйте её:

```bash
export DB_DSN="postgresql:///course_quality"
```

## Логин в приложение

После настройки базы данных вы сможете войти в приложение с учетными данными:

- **Администратор**:
  - Логин: admin
  - Пароль: admin123

- **Методист**:
  - Логин: methodist
  - Пароль: methodist123 